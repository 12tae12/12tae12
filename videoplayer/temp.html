<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Top Video Player</title>
<style>
  /* ... existing styles ... */
</style>
</head>
<body>
<!-- ... existing HTML ... -->
<script>
  const elements = {
    /* ... existing elements ... */
  };

  let isFullscreen = false;
  let isLooping = false;
  let lastVolume = 1;
  let currentSpeed = 1;
  let currentQuality = 'hd';

  // Audio visualizer setup
  const visualizer = {
    context: null,
    analyser: null,
    source: null,
    dataArray: null,
    bufferLength: null,
    animationFrame: null,
    
    async init() {
      if (!this.context) {
        try {
          this.context = new (window.AudioContext || window.webkitAudioContext)();
          this.analyser = this.context.createAnalyser();
          this.source = this.context.createMediaElementSource(elements.videoPlayer);
          this.source.connect(this.analyser);
          this.analyser.connect(this.context.destination);
          
          this.analyser.fftSize = 256;
          this.bufferLength = this.analyser.frequencyBinCount;
          this.dataArray = new Uint8Array(this.bufferLength);
          
          if (this.context.state === 'suspended') {
            await this.context.resume();
          }
        } catch (error) {
          console.error('Failed to initialize audio context:', error);
        }
      }
    },
    
    draw() {
      if (!this.context || !this.analyser) return;
      
      const canvas = elements.audioVisualizer;
      const ctx = canvas.getContext('2d');
      
      canvas.width = elements.videoContainer.offsetWidth;
      canvas.height = 100;
      
      ctx.fillStyle = '#001100';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      this.analyser.getByteFrequencyData(this.dataArray);
      
      const barWidth = (canvas.width / this.bufferLength) * 2.5;
      let x = 0;
      
      for (let i = 0; i < this.bufferLength; i++) {
        const barHeight = this.dataArray[i] * 0.7;
        const green = Math.min(255, barHeight + 100);
        
        ctx.fillStyle = `rgb(0, ${green}, 0)`;
        ctx.fillRect(x, canvas.height - barHeight, barWidth - 1, barHeight);
        
        x += barWidth;
      }
      
      if (!elements.videoPlayer.paused) {
        this.animationFrame = requestAnimationFrame(() => this.draw());
      }
    },
    
    start() {
      this.init().then(() => {
        if (elements.audioOverlay.style.display === 'block') {
          elements.audioVisualizer.style.display = 'block';
          this.draw();
        } else {
          elements.audioVisualizer.style.display = 'none';
        }
      });
    },
    
    stop() {
      if (this.animationFrame) {
        cancelAnimationFrame(this.animationFrame);
        this.animationFrame = null;
      }
    }
  };

  function initPlayer() {
    elements.videoPlayer.controls = false;
    elements.customControls.style.display = 'flex';

    // ... existing control setup ...

    // Add visualizer events
    elements.videoPlayer.addEventListener('play', () => visualizer.start());
    elements.videoPlayer.addEventListener('pause', () => visualizer.stop());
    elements.videoPlayer.addEventListener('ended', () => visualizer.stop());
  }

  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
      const fileURL = URL.createObjectURL(file);
      const isAudio = file.type.startsWith('audio/');
      
      elements.videoPlayer.pause();
      elements.videoPlayer.src = fileURL;
      elements.videoPlayer.load();
      
      elements.videoTitle.textContent = file.name;
      elements.videoInfo.textContent = 'Loading...';
      elements.audioOverlay.style.display = isAudio ? 'block' : 'none';
      elements.videoPlayer.classList.toggle('audio-mode', isAudio);
      
      let metadataLoaded = false;
      let dataLoaded = false;
      
      elements.videoPlayer.addEventListener('loadedmetadata', function onMetaLoad() {
        elements.videoPlayer.removeEventListener('loadedmetadata', onMetaLoad);
        metadataLoaded = true;
        if (dataLoaded) updateMedia();
      });
      
      elements.videoPlayer.addEventListener('loadeddata', function onDataLoad() {
        elements.videoPlayer.removeEventListener('loadeddata', onDataLoad);
        dataLoaded = true;
        if (metadataLoaded) updateMedia();
      });
      
      function updateMedia() {
        updateDuration();
        updateVideoInfo(file);
        elements.videoPlayer.playbackRate = currentSpeed;
        elements.videoPlayer.play().catch(e => {
          elements.videoInfo.textContent = 'Click the play button to start playback';
        });
      }
    }
  }

  function updateVideoInfo(file) {
    const video = elements.videoPlayer;
    const resolution = video.videoWidth && video.videoHeight ? `${video.videoWidth}x${video.videoHeight}` : 'N/A';
    const duration = formatTime(video.duration || 0);
    const codec = file.type;
    const bitrate = (file.size * 8 / (video.duration || 1) / 1024).toFixed(0);
    const hours = Math.floor(video.duration / 3600);
    const minutes = Math.floor((video.duration % 3600) / 60);
    const seconds = Math.floor(video.duration % 60);
    const durationStr = hours > 0 ? 
      `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}` :
      `${minutes}:${seconds.toString().padStart(2, '0')}`;

    elements.videoInfo.textContent = 
      `File size: ${(file.size / (1024 * 1024)).toFixed(2)} MB | ` +
      `Type: ${codec} | ` +
      `Resolution: ${resolution} | ` +
      `Duration: ${durationStr} | ` +
      `Bitrate: ${bitrate} kbps`;
  }

  function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    const hours = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    return hours > 0 ?
      `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}` :
      `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // ... rest of the existing functions ...

  document.addEventListener('DOMContentLoaded', initPlayer);
</script>
</body>
</html>
